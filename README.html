<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />

        
        
  
  <title>
          
      minimal example of interaction between two entities (IPC).
      </title>

  
      <style type="text/css">a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */</style>
  
  
  
  
  <style type="text/css">
    body {
      font-weight: 400;
      font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    }

    h1, h2, h3, h4, h5, h6, th {
      font-weight: 600;
      margin-top: 24px;
      margin-bottom: 16px;
      line-height: 1.25;
    }

    a, a:visited, a:hover, a:active {
      color: #009982;
      font-weight: normal;
      text-decoration: underline;
    }

    code:not(.sourceCode) {
      font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
      background: #F4F6FA;
      border-radius: 4px;
      color: #22662c;
      font-size: 90%;
      padding: 1px 4px;
      white-space: pre-wrap;
    }

    .content {
      margin: 0 auto;
      min-width: 200px;
      max-width: 980px;
      padding: 2em;
      color: #54585a;
    }

    .content * {
      box-sizing: border-box;
    }

    .content strong {
      font-weight: 600;
    }

    .content hr {
      box-sizing: content-box;
      overflow: hidden;
      background: 0 0;
      border: none;
      border-bottom: 1px solid #D8DFEE;
      margin: 1rem 0;
    }

    .content hr::before {
      display: table;
      content: "";
    }

    .content hr::after {
      display: table;
      clear: both;
      content: "";
    }

    .content h1 {
      border-bottom: 2px solid #009982;
      padding-bottom: .3em;
    }

    .content h2 {
      border-bottom: 1px solid #009982;
      padding-bottom: .3em;
    }

    .content dd {
      margin-left: 0;
    }

    .content blockquote,
    .content dl,
    .content ol,
    .content p,
    .content pre,
    .content table,
    .content ul,
    .content details {
      margin-top: 0;
      margin-bottom: 1rem;
    }

    .content nav#TOC {
      margin-bottom: 2rem;
    }

    .content nav#TOC ul {
      margin-bottom: initial;
    }

    .content nav#TOC li {
      margin: 0.3rem 0;
    }

    .content li {
      margin: 1rem 0;
      text-align: left;
    }

    .content li > p {
      margin: 0.5rem 0;
    }

    .content summary {
      color: #009982;
      text-decoration: underline;
      font-weight: 600;
      cursor: pointer;
    }

    .content summary:after {
      display: inline-block;
      content: '⍰';
      font-weight: normal;
      margin-left: 1ex;
    }

    .content div.sourceCode {
      padding: 1rem 1.5rem;
      background-color: #F4F6FA;
      border: 1px solid #D8DFEE;
      border-radius: 7px;
    }

    .content div.Warning,
    .content div.Error,
    .content div.Success,
    .content div.Info {
      position: relative;
      padding: 16px;
      margin: 1em 0;
      color: #246;
      background-color: #e2eef9;
      border: 1px solid #bac6d3;
      border-radius: 3px;
    }

    .content div.Warning p:last-child,
    .content div.Error p:last-child,
    .content div.Success p:last-child,
    .content div.Info p:last-child {
      margin-bottom: 0;
    }

    .content div.Warning {
      color: #4c4a42;
      background-color: #fff9ea;
      border-color: #dfd8c2;
    }

    .content div.Error {
      color: #911;
      background-color: #fcdede;
      border-color: #d2b2b2;
    }

    .content div.Success {
      color: #22662c;
      background-color: #e2f9e5;
      border-color: #bad3be;
    }

    .content div.Info {
      color: #4c4a42;
      background-color: #f5f5f5;
      border-color: #c1c1c1;
    }

    .footer {
      background: #fff;
      color: #979797;
      font-size: .75rem;
      font-weight: 300;
      padding: 0 0 40px;
    }

    .footer__divider {
      border-top: 1px solid #e4e4e4;
      padding: 0 0 20px;
    }

    .footer__text {
      -webkit-box-flex: 1;
      -webkit-flex: 1;
      -moz-box-flex: 1;
      -ms-flex: 1;
      flex: 1;
      font-weight: 300;
      overflow: hidden;
      text-align: left;
    }

    code > a.sourceLine {
      display: inline-block;
      white-space: pre;
      width: 100%;
    }
    code > a.sourceLine::after {
      content: "\A";
      white-space: pre;
    }
  </style>
</head>
<body>
  <article class="content">
    
          <header>
        <h1 class="title">Interaction between two entities (echo)</h1>

        
        
              </header>
    
          <nav id="TOC"><ul>
<li><a href="#description-of-the-client-entity">Description of the <code>Client</code> entity</a></li>
<li><a href="#description-of-the-server-entity">Description of the <code>Server</code> entity</a></li>
<li><a href="#init-description">Init description</a></li>
<li><a href="#security-configuration">Security configuration</a></li>
<li><a href="#implementation-of-the-client-entity">Implementation of the <code>Client</code> entity</a></li>
<li><a href="#implementation-of-the-server-entity">Implementation of the <code>Server</code> entity</a></li>
<li><a href="#build-script">Build script</a></li>
</ul></nav>
    
    <div id="pandoc-body"><p>Example implementation of the client-server model in which the <code>Client</code> entity sends a number to the <code>Server</code> entity, receives a modified number and prints it to <code>stderr</code>.</p>
<h2 id="description-of-the-client-entity">Description of the <code>Client</code> entity</h2>
<p>The <code>Client</code> entity does not provide functionality available to other entities, therefore it is sufficient to declare just the entity name in the description.</p>
<details>
<p><summary>Client.edl</summary></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb1-1" data-line-number="1">entity echo.Client</a></code></pre></div>
</details>
<h2 id="description-of-the-server-entity">Description of the <code>Server</code> entity</h2>
<p>EDL description of the <code>Server</code> entity contains a named instance of the <code>ping</code> component (<code>ping</code>).</p>
<details>
<p><summary>Server.edl</summary></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb2-1" data-line-number="1">entity echo.Server</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"></a>
<a class="sourceLine" id="cb2-3" data-line-number="3">components {</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">    Server : echo.Ping</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">}</a></code></pre></div>
</details>
<details>
<p><summary>CMakeLists.txt</summary></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb3-1" data-line-number="1">project (server)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="er"># Tools for using NK parser.</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4">include (platform/nk)</a>
<a class="sourceLine" id="cb3-5" data-line-number="5"></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="er"># Set compile flags.</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7">project_header_default (<span class="st">&quot;STANDARD_GNU_11:YES&quot;</span> <span class="st">&quot;STRICT_WARNINGS:NO&quot;</span>)</a>
<a class="sourceLine" id="cb3-8" data-line-number="8"></a>
<a class="sourceLine" id="cb3-9" data-line-number="9">add_executable (Server <span class="st">&quot;src/server.c&quot;</span>)</a>
<a class="sourceLine" id="cb3-10" data-line-number="10">add_dependencies (Server echo_server_edl_files)</a>
<a class="sourceLine" id="cb3-11" data-line-number="11"></a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="er">#set_target_properties (Server PROPERTIES LINK_FLAGS &quot;-Ttext 0x00c00000&quot;)</span></a></code></pre></div>
</details>
<p>CDL description of the <code>ping</code> component contains named implementation of the Ping interface from the <code>ping</code> package.</p>
<details>
<p><summary>Ping.cdl</summary></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co">/* Definition of the `ping` component. */</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"></a>
<a class="sourceLine" id="cb4-3" data-line-number="3">component echo.Ping</a>
<a class="sourceLine" id="cb4-4" data-line-number="4"></a>
<a class="sourceLine" id="cb4-5" data-line-number="5">endpoints {</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">    <span class="co">/* Declaration of a named implementation of the &quot;Ping&quot; interface. */</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7">    ping : echo.Ping</a>
<a class="sourceLine" id="cb4-8" data-line-number="8">}</a></code></pre></div>
</details>
<p>IDL description of the package with the Ping interface description.</p>
<details>
<p><summary>Ping.idl</summary></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co">/* Package with an &quot;IPing&quot; interface declaration. */</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"></a>
<a class="sourceLine" id="cb5-3" data-line-number="3">package echo.Ping</a>
<a class="sourceLine" id="cb5-4" data-line-number="4"></a>
<a class="sourceLine" id="cb5-5" data-line-number="5">interface {</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">    <span class="co">/* Ping method interface. */</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7">    Ping(in UInt32 value, out UInt32 result);</a>
<a class="sourceLine" id="cb5-8" data-line-number="8">}</a></code></pre></div>
</details>
<h2 id="init-description">Init description</h2>
<p>To enable the <code>Client</code> entity to call methods of the <code>Server</code> entity, you need to declare this in the init description.</p>
<details>
<p><summary>init.yaml</summary></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="fu">entities:</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="co"># The `client` entity can call `server`.</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> echo.Client</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5">  <span class="fu">connections:</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6">  <span class="kw">-</span> <span class="fu">target:</span><span class="at"> echo.Server</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7">    <span class="fu">id:</span><span class="at"> server_connection</span></a>
<a class="sourceLine" id="cb6-8" data-line-number="8">@INIT_client_ENTITY_CONNECTIONS@</a>
<a class="sourceLine" id="cb6-9" data-line-number="9"></a>
<a class="sourceLine" id="cb6-10" data-line-number="10"></a>
<a class="sourceLine" id="cb6-11" data-line-number="11"><span class="co"># The `server` entity can only respond to requests.</span></a>
<a class="sourceLine" id="cb6-12" data-line-number="12"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> echo.Server</span></a>
<a class="sourceLine" id="cb6-13" data-line-number="13">@INIT_server_ENTITY_CONNECTIONS@</a>
<a class="sourceLine" id="cb6-14" data-line-number="14"></a></code></pre></div>
</details>
<h2 id="security-configuration">Security configuration</h2>
<p>The security configuration in this example allows you to run all entities and any entity may call <code>Core</code> and <code>Server</code> entities.</p>
<details>
<p><summary>security.psl</summary></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="co">/* Security configuration of the &quot;echo&quot; example. */</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="co">/* Definition of the execute interface. */</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4">execute: kl.core.Execute</a>
<a class="sourceLine" id="cb7-5" data-line-number="5"></a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="co">/* Import the file with the declaration of basic security policy aliases. */</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7">use nk.base._</a>
<a class="sourceLine" id="cb7-8" data-line-number="8"></a>
<a class="sourceLine" id="cb7-9" data-line-number="9"><span class="co">/* Declaration of entities. */</span></a>
<a class="sourceLine" id="cb7-10" data-line-number="10">use EDL Einit</a>
<a class="sourceLine" id="cb7-11" data-line-number="11">use EDL kl.core.Core</a>
<a class="sourceLine" id="cb7-12" data-line-number="12"></a>
<a class="sourceLine" id="cb7-13" data-line-number="13">use EDL echo.Client</a>
<a class="sourceLine" id="cb7-14" data-line-number="14">use EDL echo.Server</a>
<a class="sourceLine" id="cb7-15" data-line-number="15"></a>
<a class="sourceLine" id="cb7-16" data-line-number="16"><span class="co">/* Execution of entities allowed. */</span></a>
<a class="sourceLine" id="cb7-17" data-line-number="17">execute {</a>
<a class="sourceLine" id="cb7-18" data-line-number="18">    grant ()</a>
<a class="sourceLine" id="cb7-19" data-line-number="19">}</a>
<a class="sourceLine" id="cb7-20" data-line-number="20"></a>
<a class="sourceLine" id="cb7-21" data-line-number="21"><span class="co">/* Request messages allowed. */</span></a>
<a class="sourceLine" id="cb7-22" data-line-number="22">request {</a>
<a class="sourceLine" id="cb7-23" data-line-number="23">    grant ()</a>
<a class="sourceLine" id="cb7-24" data-line-number="24">}</a>
<a class="sourceLine" id="cb7-25" data-line-number="25"></a>
<a class="sourceLine" id="cb7-26" data-line-number="26"><span class="co">/* Response messages allowed. */</span></a>
<a class="sourceLine" id="cb7-27" data-line-number="27">response {</a>
<a class="sourceLine" id="cb7-28" data-line-number="28">    grant ()</a>
<a class="sourceLine" id="cb7-29" data-line-number="29">}</a>
<a class="sourceLine" id="cb7-30" data-line-number="30"></a>
<a class="sourceLine" id="cb7-31" data-line-number="31">error {</a>
<a class="sourceLine" id="cb7-32" data-line-number="32">    grant ()</a>
<a class="sourceLine" id="cb7-33" data-line-number="33">}</a>
<a class="sourceLine" id="cb7-34" data-line-number="34"></a>
<a class="sourceLine" id="cb7-35" data-line-number="35"><span class="co">/* Calls to the security interface are ignored. */</span></a>
<a class="sourceLine" id="cb7-36" data-line-number="36">security {</a>
<a class="sourceLine" id="cb7-37" data-line-number="37">    grant ()</a>
<a class="sourceLine" id="cb7-38" data-line-number="38">}</a></code></pre></div>
</details>
<h2 id="implementation-of-the-client-entity">Implementation of the <code>Client</code> entity</h2>
<p><em>To implement an entity serving in the client role, in the entity code</em>:</p>
<ol type="1">
<li>Include the header files of the description of all interfaces called by the client entity.</li>
<li>For each connection for the specific client entity, perform the following actions:
<ol type="1">
<li>Receive the client connection descriptor by using the <code>ServiceLocatorConnect</code> function.</li>
<li>Initialize transport for received descriptor using the <code>NkKosTransport_Init</code> function.</li>
</ol></li>
<li>For each interface implementation called by the client entity:
<ol type="1">
<li>Receive the Runtime Interface ID (RIID) using the <code>ServiceLocatorGetRiid</code> function by passing the previously received descriptor of the connection and the name of the interface implementation. The interface implementation name is specified in the following format: <code>ComponentInstance.InterfaceImplementation</code> from the EDL and CDL descriptions of the entity.</li>
<li><p>Initialize proxy objects.</p>
<p><em>Proxy objects</em> forward the requests through the specified interface via IPC.</p>
<p>To initialize a proxy object, you must call the method that will be generated based on the EDL description and pass within it the previously initialized transport and RIID.</p>
The generated method has a name in the following format: <code>InterfaceName_proxy_init</code>.</li>
</ol></li>
<li><p>To call the interface implementation, call the generated method in the server entity. The generated method has a name in the following format: <code>InterfaceName_MethodName</code>.</p>
<p>The previously initialized proxy object, request, and variable to which the response will be written must be passed to this method.</p></li>
</ol>
<details>
<p><summary>client.c</summary></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb8-1" data-line-number="1"></a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="pp">#include </span><span class="im">&lt;stdint.h&gt;</span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5"></a>
<a class="sourceLine" id="cb8-6" data-line-number="6"><span class="co">/* Files required for transport initialization. */</span></a>
<a class="sourceLine" id="cb8-7" data-line-number="7"><span class="pp">#include </span><span class="im">&lt;coresrv/nk/transport-kos.h&gt;</span></a>
<a class="sourceLine" id="cb8-8" data-line-number="8"><span class="pp">#include </span><span class="im">&lt;coresrv/sl/sl_api.h&gt;</span></a>
<a class="sourceLine" id="cb8-9" data-line-number="9"></a>
<a class="sourceLine" id="cb8-10" data-line-number="10"><span class="co">/* Description of the server interface used by the `client` entity. */</span></a>
<a class="sourceLine" id="cb8-11" data-line-number="11"><span class="pp">#include </span><span class="im">&lt;echo/Ping.idl.h&gt;</span></a>
<a class="sourceLine" id="cb8-12" data-line-number="12"></a>
<a class="sourceLine" id="cb8-13" data-line-number="13"><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></a>
<a class="sourceLine" id="cb8-14" data-line-number="14"></a>
<a class="sourceLine" id="cb8-15" data-line-number="15"><span class="pp">#define EXAMPLE_VALUE_TO_SEND 777</span></a>
<a class="sourceLine" id="cb8-16" data-line-number="16"></a>
<a class="sourceLine" id="cb8-17" data-line-number="17"><span class="co">/* Client entity entry point. */</span></a>
<a class="sourceLine" id="cb8-18" data-line-number="18"><span class="dt">int</span> main(<span class="dt">int</span> argc, <span class="dt">const</span> <span class="dt">char</span> *argv[])</a>
<a class="sourceLine" id="cb8-19" data-line-number="19">{</a>
<a class="sourceLine" id="cb8-20" data-line-number="20">    NkKosTransport transport;</a>
<a class="sourceLine" id="cb8-21" data-line-number="21">    <span class="kw">struct</span> echo_Ping_proxy proxy;</a>
<a class="sourceLine" id="cb8-22" data-line-number="22">    <span class="dt">int</span> i;</a>
<a class="sourceLine" id="cb8-23" data-line-number="23"></a>
<a class="sourceLine" id="cb8-24" data-line-number="24">    fprintf(stderr, <span class="st">&quot;Hello I&#39;m client</span><span class="sc">\n</span><span class="st">&quot;</span>);</a>
<a class="sourceLine" id="cb8-25" data-line-number="25"></a>
<a class="sourceLine" id="cb8-26" data-line-number="26">    <span class="co">/* Get the client IPC handle of the connection named</span></a>
<a class="sourceLine" id="cb8-27" data-line-number="27"><span class="co">     * &quot;server_connection&quot;. */</span></a>
<a class="sourceLine" id="cb8-28" data-line-number="28">    Handle handle = ServiceLocatorConnect(<span class="st">&quot;server_connection&quot;</span>);</a>
<a class="sourceLine" id="cb8-29" data-line-number="29">    assert(handle != INVALID_HANDLE);</a>
<a class="sourceLine" id="cb8-30" data-line-number="30"></a>
<a class="sourceLine" id="cb8-31" data-line-number="31">    <span class="co">/* Initialize IPC transport for interaction with the server entity. */</span></a>
<a class="sourceLine" id="cb8-32" data-line-number="32">    NkKosTransport_Init(&amp;transport, handle, NK_NULL, <span class="dv">0</span>);</a>
<a class="sourceLine" id="cb8-33" data-line-number="33"></a>
<a class="sourceLine" id="cb8-34" data-line-number="34">    <span class="co">/* Get Runtime Interface ID (RIID) for interface echo.Ping.ping.</span></a>
<a class="sourceLine" id="cb8-35" data-line-number="35"><span class="co">     * Here ping is the name of the echo.Ping component instance,</span></a>
<a class="sourceLine" id="cb8-36" data-line-number="36"><span class="co">     * echo.Ping.ping is the name of the Ping interface implementation. */</span></a>
<a class="sourceLine" id="cb8-37" data-line-number="37">    nk_iid_t riid = ServiceLocatorGetRiid(handle, <span class="st">&quot;echo.Ping.ping&quot;</span>);</a>
<a class="sourceLine" id="cb8-38" data-line-number="38">    assert(riid != INVALID_RIID);</a>
<a class="sourceLine" id="cb8-39" data-line-number="39"></a>
<a class="sourceLine" id="cb8-40" data-line-number="40">    <span class="co">/* Initialize proxy object by specifying transport (&amp;transport)</span></a>
<a class="sourceLine" id="cb8-41" data-line-number="41"><span class="co">     * and server interface identifier (riid). Each method of the</span></a>
<a class="sourceLine" id="cb8-42" data-line-number="42"><span class="co">     * proxy object will be implemented by sending a request to the server. */</span></a>
<a class="sourceLine" id="cb8-43" data-line-number="43">    echo_Ping_proxy_init(&amp;proxy, &amp;transport.base, riid);</a>
<a class="sourceLine" id="cb8-44" data-line-number="44"></a>
<a class="sourceLine" id="cb8-45" data-line-number="45">    <span class="co">/* Request and response structures */</span></a>
<a class="sourceLine" id="cb8-46" data-line-number="46">    echo_Ping_Ping_req req;</a>
<a class="sourceLine" id="cb8-47" data-line-number="47">    echo_Ping_Ping_res res;</a>
<a class="sourceLine" id="cb8-48" data-line-number="48"></a>
<a class="sourceLine" id="cb8-49" data-line-number="49">    <span class="co">/* Test loop. */</span></a>
<a class="sourceLine" id="cb8-50" data-line-number="50">    req.value = EXAMPLE_VALUE_TO_SEND;</a>
<a class="sourceLine" id="cb8-51" data-line-number="51">    <span class="cf">for</span> (i = <span class="dv">0</span>; i &lt; <span class="dv">10</span>; ++i)</a>
<a class="sourceLine" id="cb8-52" data-line-number="52">    {</a>
<a class="sourceLine" id="cb8-53" data-line-number="53">        <span class="co">/* Call Ping interface method.</span></a>
<a class="sourceLine" id="cb8-54" data-line-number="54"><span class="co">         * Server will be sent a request for calling Ping interface method</span></a>
<a class="sourceLine" id="cb8-55" data-line-number="55"><span class="co">         * ping_comp.ping_impl with the value argument. Calling thread is locked</span></a>
<a class="sourceLine" id="cb8-56" data-line-number="56"><span class="co">         * until a response is received from the server. */</span></a>
<a class="sourceLine" id="cb8-57" data-line-number="57">        <span class="cf">if</span> (echo_Ping_Ping(&amp;proxy.base, &amp;req, NULL, &amp;res, NULL) == rcOk)</a>
<a class="sourceLine" id="cb8-58" data-line-number="58"></a>
<a class="sourceLine" id="cb8-59" data-line-number="59">        {</a>
<a class="sourceLine" id="cb8-60" data-line-number="60">            <span class="co">/* Print result value from response</span></a>
<a class="sourceLine" id="cb8-61" data-line-number="61"><span class="co">             * (result is the output argument of the Ping method). */</span></a>
<a class="sourceLine" id="cb8-62" data-line-number="62">            fprintf(stderr, <span class="st">&quot;result = %d</span><span class="sc">\n</span><span class="st">&quot;</span>, (<span class="dt">int</span>) res.result);</a>
<a class="sourceLine" id="cb8-63" data-line-number="63">            <span class="co">/* Include received result value into value argument</span></a>
<a class="sourceLine" id="cb8-64" data-line-number="64"><span class="co">             * to resend to server in next iteration. */</span></a>
<a class="sourceLine" id="cb8-65" data-line-number="65">            req.value = res.result;</a>
<a class="sourceLine" id="cb8-66" data-line-number="66"></a>
<a class="sourceLine" id="cb8-67" data-line-number="67">        }</a>
<a class="sourceLine" id="cb8-68" data-line-number="68">        <span class="cf">else</span></a>
<a class="sourceLine" id="cb8-69" data-line-number="69">            fprintf(stderr, <span class="st">&quot;Failed to call echo.Ping.Ping()</span><span class="sc">\n</span><span class="st">&quot;</span>);</a>
<a class="sourceLine" id="cb8-70" data-line-number="70">    }</a>
<a class="sourceLine" id="cb8-71" data-line-number="71"></a>
<a class="sourceLine" id="cb8-72" data-line-number="72">    <span class="cf">return</span> EXIT_SUCCESS;</a>
<a class="sourceLine" id="cb8-73" data-line-number="73">}</a></code></pre></div>
</details>
<h2 id="implementation-of-the-server-entity">Implementation of the <code>Server</code> entity</h2>
<p><em>To implement an entity serving in the server role, in the entity code</em>:</p>
<ol type="1">
<li>Include the header file of the server entity description in the EDL language.</li>
<li>Implement the functions that are contained in interfaces provided by the server entity.</li>
<li>Create constructors for the provided interfaces (see the <code>CreateIPingImpl</code> function implementation).</li>
<li>For each connection with the server entity, perform the following actions:
<ol type="1">
<li>Receive the server connection descriptor by using the <code>ServiceLocatorRegister</code> function.</li>
<li>Initialize transport for received descriptor using the <code>NkKosTransport_Init</code> function.</li>
</ol></li>
<li>Initialize the server entity and its components.</li>
<li>Prepare data buffers for receiving a request and response to it.</li>
<li>Implement the request handling cycle.</li>
</ol>
<details>
<p><summary>server.c</summary></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb9-1" data-line-number="1"></a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="pp">#include </span><span class="im">&lt;stdbool.h&gt;</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="co">/* Files required for transport initialization. */</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="pp">#include </span><span class="im">&lt;coresrv/nk/transport-kos.h&gt;</span></a>
<a class="sourceLine" id="cb9-8" data-line-number="8"><span class="pp">#include </span><span class="im">&lt;coresrv/sl/sl_api.h&gt;</span></a>
<a class="sourceLine" id="cb9-9" data-line-number="9"></a>
<a class="sourceLine" id="cb9-10" data-line-number="10"><span class="co">/* EDL description of the server entity. */</span></a>
<a class="sourceLine" id="cb9-11" data-line-number="11"><span class="pp">#include </span><span class="im">&lt;echo/Server.edl.h&gt;</span></a>
<a class="sourceLine" id="cb9-12" data-line-number="12"></a>
<a class="sourceLine" id="cb9-13" data-line-number="13"><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></a>
<a class="sourceLine" id="cb9-14" data-line-number="14"></a>
<a class="sourceLine" id="cb9-15" data-line-number="15"><span class="co">/* Type of interface implementing object. */</span></a>
<a class="sourceLine" id="cb9-16" data-line-number="16"><span class="kw">typedef</span> <span class="kw">struct</span> IPingImpl {</a>
<a class="sourceLine" id="cb9-17" data-line-number="17">    <span class="kw">struct</span> echo_Ping base;     <span class="co">// Base interface of object</span></a>
<a class="sourceLine" id="cb9-18" data-line-number="18">    <span class="dt">int</span> step;             <span class="co">// Extra parameters</span></a>
<a class="sourceLine" id="cb9-19" data-line-number="19">} IPingImpl;</a>
<a class="sourceLine" id="cb9-20" data-line-number="20"></a>
<a class="sourceLine" id="cb9-21" data-line-number="21"><span class="co">/* Ping method implementation. */</span></a>
<a class="sourceLine" id="cb9-22" data-line-number="22"><span class="dt">static</span> nk_err_t Ping_impl(<span class="kw">struct</span> echo_Ping *self,</a>
<a class="sourceLine" id="cb9-23" data-line-number="23">                          <span class="dt">const</span> echo_Ping_req *req,</a>
<a class="sourceLine" id="cb9-24" data-line-number="24">                          <span class="dt">const</span> <span class="kw">struct</span> nk_arena* req_arena,</a>
<a class="sourceLine" id="cb9-25" data-line-number="25">                          echo_Ping_res* res,</a>
<a class="sourceLine" id="cb9-26" data-line-number="26">                          <span class="kw">struct</span> nk_arena* res_arena)</a>
<a class="sourceLine" id="cb9-27" data-line-number="27">{</a>
<a class="sourceLine" id="cb9-28" data-line-number="28">    IPingImpl *impl = (IPingImpl *)self;</a>
<a class="sourceLine" id="cb9-29" data-line-number="29">    <span class="co">/* Increment value in client request by</span></a>
<a class="sourceLine" id="cb9-30" data-line-number="30"><span class="co">     * one step and include into result argument that will be</span></a>
<a class="sourceLine" id="cb9-31" data-line-number="31"><span class="co">     * sent to the client in the server response. */</span></a>
<a class="sourceLine" id="cb9-32" data-line-number="32">    res-&gt;Ping.result = req-&gt;Ping.value + impl-&gt;step;</a>
<a class="sourceLine" id="cb9-33" data-line-number="33">    <span class="cf">return</span> NK_EOK;</a>
<a class="sourceLine" id="cb9-34" data-line-number="34">}</a>
<a class="sourceLine" id="cb9-35" data-line-number="35"></a>
<a class="sourceLine" id="cb9-36" data-line-number="36"><span class="co">/* IPing object constructor.</span></a>
<a class="sourceLine" id="cb9-37" data-line-number="37"><span class="co"> * step is the number by which the input value is increased. */</span></a>
<a class="sourceLine" id="cb9-38" data-line-number="38"><span class="dt">static</span> <span class="kw">struct</span> echo_Ping *CreateIPingImpl(<span class="dt">int</span> step)</a>
<a class="sourceLine" id="cb9-39" data-line-number="39">{</a>
<a class="sourceLine" id="cb9-40" data-line-number="40">    <span class="co">/* Table of implementations of IPing interface methods. */</span></a>
<a class="sourceLine" id="cb9-41" data-line-number="41">    <span class="dt">static</span> <span class="dt">const</span> <span class="kw">struct</span> echo_Ping_ops ops = {</a>
<a class="sourceLine" id="cb9-42" data-line-number="42">        .Ping = Ping_impl</a>
<a class="sourceLine" id="cb9-43" data-line-number="43">    };</a>
<a class="sourceLine" id="cb9-44" data-line-number="44"></a>
<a class="sourceLine" id="cb9-45" data-line-number="45"></a>
<a class="sourceLine" id="cb9-46" data-line-number="46">    <span class="co">/* Interface implementing object. */</span></a>
<a class="sourceLine" id="cb9-47" data-line-number="47">    <span class="dt">static</span> <span class="kw">struct</span> IPingImpl impl = {</a>
<a class="sourceLine" id="cb9-48" data-line-number="48">        .base = {&amp;ops}</a>
<a class="sourceLine" id="cb9-49" data-line-number="49">    };</a>
<a class="sourceLine" id="cb9-50" data-line-number="50"></a>
<a class="sourceLine" id="cb9-51" data-line-number="51">    impl.step = step;</a>
<a class="sourceLine" id="cb9-52" data-line-number="52"></a>
<a class="sourceLine" id="cb9-53" data-line-number="53">    <span class="cf">return</span> &amp;impl.base;</a>
<a class="sourceLine" id="cb9-54" data-line-number="54"></a>
<a class="sourceLine" id="cb9-55" data-line-number="55">}</a>
<a class="sourceLine" id="cb9-56" data-line-number="56"></a>
<a class="sourceLine" id="cb9-57" data-line-number="57"><span class="co">/* Server entry point. */</span></a>
<a class="sourceLine" id="cb9-58" data-line-number="58"><span class="dt">int</span> main(<span class="dt">void</span>)</a>
<a class="sourceLine" id="cb9-59" data-line-number="59">{</a>
<a class="sourceLine" id="cb9-60" data-line-number="60">    NkKosTransport transport;</a>
<a class="sourceLine" id="cb9-61" data-line-number="61">    ServiceId iid;</a>
<a class="sourceLine" id="cb9-62" data-line-number="62"></a>
<a class="sourceLine" id="cb9-63" data-line-number="63">    <span class="co">/* Get server IPC handle of &quot;server_connection&quot;. */</span></a>
<a class="sourceLine" id="cb9-64" data-line-number="64">    Handle handle = ServiceLocatorRegister(<span class="st">&quot;server_connection&quot;</span>, NULL, <span class="dv">0</span>, &amp;iid);</a>
<a class="sourceLine" id="cb9-65" data-line-number="65">    assert(handle != INVALID_HANDLE);</a>
<a class="sourceLine" id="cb9-66" data-line-number="66"></a>
<a class="sourceLine" id="cb9-67" data-line-number="67">    <span class="co">/* Initialize transport to client. */</span></a>
<a class="sourceLine" id="cb9-68" data-line-number="68">    NkKosTransport_Init(&amp;transport, handle, NK_NULL, <span class="dv">0</span>);</a>
<a class="sourceLine" id="cb9-69" data-line-number="69"></a>
<a class="sourceLine" id="cb9-70" data-line-number="70">    <span class="co">/* Prepare the structures of the request to the server entity: constant</span></a>
<a class="sourceLine" id="cb9-71" data-line-number="71"><span class="co">     * part and arena. Because none of the methods of the server entity has</span></a>
<a class="sourceLine" id="cb9-72" data-line-number="72"><span class="co">     * sequence type arguments, only constant parts of the</span></a>
<a class="sourceLine" id="cb9-73" data-line-number="73"><span class="co">     * request and response are used. Arenas are effectively unused. However,</span></a>
<a class="sourceLine" id="cb9-74" data-line-number="74"><span class="co">     * valid arenas of the request and response must be passed to</span></a>
<a class="sourceLine" id="cb9-75" data-line-number="75"><span class="co">     * server transport methods (nk_transport_recv, nk_transport_reply) and</span></a>
<a class="sourceLine" id="cb9-76" data-line-number="76"><span class="co">     * to the server_entity_dispatch method. */</span></a>
<a class="sourceLine" id="cb9-77" data-line-number="77">    echo_Server_entity_req req;</a>
<a class="sourceLine" id="cb9-78" data-line-number="78">    <span class="dt">char</span> req_buffer[echo_Server_entity_req_arena_size];</a>
<a class="sourceLine" id="cb9-79" data-line-number="79">    <span class="kw">struct</span> nk_arena req_arena = NK_ARENA_INITIALIZER(req_buffer, req_buffer + <span class="kw">sizeof</span>(req_buffer));</a>
<a class="sourceLine" id="cb9-80" data-line-number="80"></a>
<a class="sourceLine" id="cb9-81" data-line-number="81">    <span class="co">/* Prepare response structures: constant part and arena. */</span></a>
<a class="sourceLine" id="cb9-82" data-line-number="82">    echo_Server_entity_res res;</a>
<a class="sourceLine" id="cb9-83" data-line-number="83">    <span class="dt">char</span> res_buffer[echo_Server_entity_res_arena_size];</a>
<a class="sourceLine" id="cb9-84" data-line-number="84">    <span class="kw">struct</span> nk_arena res_arena = NK_ARENA_INITIALIZER(res_buffer, res_buffer + <span class="kw">sizeof</span>(res_buffer));</a>
<a class="sourceLine" id="cb9-85" data-line-number="85"></a>
<a class="sourceLine" id="cb9-86" data-line-number="86">    <span class="co">/* Initialize ping component dispatcher. 3 is the value of the step,</span></a>
<a class="sourceLine" id="cb9-87" data-line-number="87"><span class="co">     * which is the number by which the input value is increased. */</span></a>
<a class="sourceLine" id="cb9-88" data-line-number="88">    echo_Ping_component component;</a>
<a class="sourceLine" id="cb9-89" data-line-number="89">    echo_Ping_component_init(&amp;component, CreateIPingImpl(<span class="dv">3</span>));</a>
<a class="sourceLine" id="cb9-90" data-line-number="90"></a>
<a class="sourceLine" id="cb9-91" data-line-number="91">    <span class="co">/* Initialize server entity dispatcher. */</span></a>
<a class="sourceLine" id="cb9-92" data-line-number="92">    echo_Server_entity entity;</a>
<a class="sourceLine" id="cb9-93" data-line-number="93">    echo_Server_entity_init(&amp;entity, &amp;component);</a>
<a class="sourceLine" id="cb9-94" data-line-number="94"></a>
<a class="sourceLine" id="cb9-95" data-line-number="95">    fprintf(stderr, <span class="st">&quot;Hello I&#39;m server</span><span class="sc">\n</span><span class="st">&quot;</span>);</a>
<a class="sourceLine" id="cb9-96" data-line-number="96"></a>
<a class="sourceLine" id="cb9-97" data-line-number="97">    <span class="co">/* Dispatch loop implementation. */</span></a>
<a class="sourceLine" id="cb9-98" data-line-number="98">    <span class="cf">do</span></a>
<a class="sourceLine" id="cb9-99" data-line-number="99">    {</a>
<a class="sourceLine" id="cb9-100" data-line-number="100">        <span class="co">/* Flush request/response buffers. */</span></a>
<a class="sourceLine" id="cb9-101" data-line-number="101">        nk_req_reset(&amp;req);</a>
<a class="sourceLine" id="cb9-102" data-line-number="102">        nk_arena_reset(&amp;req_arena);</a>
<a class="sourceLine" id="cb9-103" data-line-number="103">        nk_arena_reset(&amp;res_arena);</a>
<a class="sourceLine" id="cb9-104" data-line-number="104"></a>
<a class="sourceLine" id="cb9-105" data-line-number="105">        <span class="co">/* Wait for request to server entity. */</span></a>
<a class="sourceLine" id="cb9-106" data-line-number="106">        <span class="cf">if</span> (nk_transport_recv(&amp;transport.base, &amp;req.base_, &amp;req_arena) != NK_EOK) {</a>
<a class="sourceLine" id="cb9-107" data-line-number="107">            fprintf(stderr, <span class="st">&quot;nk_transport_recv error</span><span class="sc">\n</span><span class="st">&quot;</span>);</a>
<a class="sourceLine" id="cb9-108" data-line-number="108">        } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb9-109" data-line-number="109">            <span class="co">/* Handle received request by calling implementation Ping_impl</span></a>
<a class="sourceLine" id="cb9-110" data-line-number="110"><span class="co">             * of the requested Ping interface method. */</span></a>
<a class="sourceLine" id="cb9-111" data-line-number="111">            echo_Server_entity_dispatch(&amp;entity, &amp;req.base_, &amp;req_arena, &amp;res.base_, &amp;res_arena);</a>
<a class="sourceLine" id="cb9-112" data-line-number="112">        }</a>
<a class="sourceLine" id="cb9-113" data-line-number="113"></a>
<a class="sourceLine" id="cb9-114" data-line-number="114"></a>
<a class="sourceLine" id="cb9-115" data-line-number="115">        <span class="co">/* Send response. */</span></a>
<a class="sourceLine" id="cb9-116" data-line-number="116">        <span class="cf">if</span> (nk_transport_reply(&amp;transport.base, &amp;res.base_, &amp;res_arena) != NK_EOK) {</a>
<a class="sourceLine" id="cb9-117" data-line-number="117">            fprintf(stderr, <span class="st">&quot;nk_transport_reply error</span><span class="sc">\n</span><span class="st">&quot;</span>);</a>
<a class="sourceLine" id="cb9-118" data-line-number="118">        }</a>
<a class="sourceLine" id="cb9-119" data-line-number="119">    }</a>
<a class="sourceLine" id="cb9-120" data-line-number="120">    <span class="cf">while</span> (true);</a>
<a class="sourceLine" id="cb9-121" data-line-number="121"></a>
<a class="sourceLine" id="cb9-122" data-line-number="122">    <span class="cf">return</span> EXIT_SUCCESS;</a>
<a class="sourceLine" id="cb9-123" data-line-number="123">}</a></code></pre></div>
</details>
<h2 id="build-script">Build script</h2>
<p>The CMake build system is used in this example.</p>
<details>
<p><summary>CMakeLists.txt</summary></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode makefile"><code class="sourceCode makefile"><a class="sourceLine" id="cb10-1" data-line-number="1">cmake_minimum_required (VERSION 3.12)</a>
<a class="sourceLine" id="cb10-2" data-line-number="2"></a>
<a class="sourceLine" id="cb10-3" data-line-number="3">project (echo)</a>
<a class="sourceLine" id="cb10-4" data-line-number="4"></a>
<a class="sourceLine" id="cb10-5" data-line-number="5"><span class="co"># Initialize CMake library for KasperskyOS SDK.</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6"><span class="kw">include</span> (platform)</a>
<a class="sourceLine" id="cb10-7" data-line-number="7">initialize_platform (FORCE_STATIC)</a>
<a class="sourceLine" id="cb10-8" data-line-number="8"></a>
<a class="sourceLine" id="cb10-9" data-line-number="9"><span class="co"># Add Doxygen documentation</span></a>
<a class="sourceLine" id="cb10-10" data-line-number="10"><span class="kw">include</span> (platform/doxygen)</a>
<a class="sourceLine" id="cb10-11" data-line-number="11">add_project_documentation_main_target ()</a>
<a class="sourceLine" id="cb10-12" data-line-number="12"></a>
<a class="sourceLine" id="cb10-13" data-line-number="13"><span class="co"># Tools for using NK parser.</span></a>
<a class="sourceLine" id="cb10-14" data-line-number="14"><span class="kw">include</span> (platform/nk)</a>
<a class="sourceLine" id="cb10-15" data-line-number="15"></a>
<a class="sourceLine" id="cb10-16" data-line-number="16">nk_build_idl_files (echo_idl_files NK_MODULE <span class="st">&quot;echo&quot;</span> IDL <span class="st">&quot;resources/Ping.idl&quot;</span>)</a>
<a class="sourceLine" id="cb10-17" data-line-number="17">nk_build_cdl_files (echo_cdl_files IDL_TARGET echo_idl_files NK_MODULE <span class="st">&quot;echo&quot;</span> CDL <span class="st">&quot;resources/Ping.cdl&quot;</span>)</a>
<a class="sourceLine" id="cb10-18" data-line-number="18">nk_build_edl_files (echo_server_edl_files CDL_TARGET echo_cdl_files NK_MODULE <span class="st">&quot;echo&quot;</span> EDL <span class="st">&quot;resources/Server.edl&quot;</span>)</a>
<a class="sourceLine" id="cb10-19" data-line-number="19">nk_build_edl_files (echo_client_edl_files NK_MODULE <span class="st">&quot;echo&quot;</span> EDL <span class="st">&quot;resources/Client.edl&quot;</span>)</a>
<a class="sourceLine" id="cb10-20" data-line-number="20"></a>
<a class="sourceLine" id="cb10-21" data-line-number="21">add_subdirectory (client)</a>
<a class="sourceLine" id="cb10-22" data-line-number="22">add_subdirectory (server)</a>
<a class="sourceLine" id="cb10-23" data-line-number="23">add_subdirectory (einit)</a></code></pre></div>
</details></div>

          Information about third-party code is contained in the file legal_notices.txt, in the application installation folder.
    
    <footer>
      <div class="row">
        <div class="footer__divider"></div>
        <div class="footer__text">
                      © 2018 AO Kaspersky Lab. All Rights Reserved.
                  </div>
      </div>
    </footer>
  </article>
  <script>
    // Expand code sections before printing
    function beforePrint() {
      var details = document.getElementsByTagName("details")
      for (var i = 0; i < details.length; i++) {
        details[i].setAttribute("open", "")
      }
    }
    if (window.matchMedia) {
      window.matchMedia("print")
        .addListener(function(mql) {
          if (mql.matches)
              beforePrint()
        })
    }
    window.onbeforeprint = beforePrint
  </script>
</body>
</html>
